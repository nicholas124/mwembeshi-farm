// Prisma Schema for Mwembeshi Farm Management System
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// USER & AUTHENTICATION
// ==========================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  phone         String?
  role          UserRole  @default(STAFF)
  password      String
  avatar        String?
  isActive      Boolean   @default(true)
  language      String    @default("en") // en, bem, nya
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  tasksAssigned   Task[]           @relation("AssignedTasks")
  tasksCreated    Task[]           @relation("CreatedTasks")
  attendances     Attendance[]
  equipmentUsage  EquipmentUsage[]
  animalRecords   Animal[]         @relation("RecordedBy")
  treatments      Treatment[]
  harvests        Harvest[]
  sprayPlansCompleted SprayPlan[]

  @@map("users")
}

enum UserRole {
  ADMIN      // Farm owner/manager - full access
  SUPERVISOR // Can manage workers, view reports
  STAFF      // Farm workers - limited access
}

// ==========================================
// LIVESTOCK MANAGEMENT
// ==========================================

model Animal {
  id            String        @id @default(cuid())
  tag           String        @unique // Farm tag/ID number
  name          String?       // Optional name (e.g., for special animals)
  type          AnimalType
  breed         String?
  gender        Gender
  dateOfBirth   DateTime?
  dateAcquired  DateTime      @default(now())
  acquisitionMethod AcquisitionMethod @default(BORN)
  purchasePrice Decimal?      @db.Decimal(10, 2)
  status        AnimalStatus  @default(ACTIVE)
  
  // Parent tracking for breeding
  motherId      String?
  fatherId      String?
  mother        Animal?       @relation("MotherOffspring", fields: [motherId], references: [id])
  father        Animal?       @relation("FatherOffspring", fields: [fatherId], references: [id])
  offspringAsMother Animal[]  @relation("MotherOffspring")
  offspringAsFather Animal[]  @relation("FatherOffspring")
  
  // Physical characteristics
  color         String?
  weight        Decimal?      @db.Decimal(8, 2) // in kg
  notes         String?
  photo         String?
  
  // Tracking
  recordedById  String?
  recordedBy    User?         @relation("RecordedBy", fields: [recordedById], references: [id])
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  treatments    Treatment[]
  weights       WeightRecord[]
  productions   Production[]  // milk, eggs, etc.
  breeding      BreedingRecord[]

  @@index([type, status])
  @@index([tag])
  @@map("animals")
}

enum AnimalType {
  GOAT
  COW
  SHEEP
  CHICKEN
  PIG
  OTHER
}

enum Gender {
  MALE
  FEMALE
  UNKNOWN
}

enum AnimalStatus {
  ACTIVE      // Currently on farm
  SOLD
  DECEASED
  TRANSFERRED
  SLAUGHTERED
}

enum AcquisitionMethod {
  PURCHASED
  BORN
  DONATED
  TRADED
}

model Treatment {
  id            String        @id @default(cuid())
  animalId      String
  animal        Animal        @relation(fields: [animalId], references: [id], onDelete: Cascade)
  type          TreatmentType
  description   String
  medication    String?
  dosage        String?
  cost          Decimal?      @db.Decimal(10, 2)
  treatmentDate DateTime      @default(now())
  nextDueDate   DateTime?     // For follow-up treatments
  veterinarian  String?       // Vet name if external
  
  administeredById String?
  administeredBy   User?      @relation(fields: [administeredById], references: [id])
  notes         String?
  createdAt     DateTime      @default(now())

  @@index([animalId, treatmentDate])
  @@map("treatments")
}

enum TreatmentType {
  VACCINATION
  DEWORMING
  MEDICATION
  SURGERY
  CHECKUP
  INJURY
  OTHER
}

model WeightRecord {
  id        String   @id @default(cuid())
  animalId  String
  animal    Animal   @relation(fields: [animalId], references: [id], onDelete: Cascade)
  weight    Decimal  @db.Decimal(8, 2)
  recordedAt DateTime @default(now())
  notes     String?

  @@index([animalId, recordedAt])
  @@map("weight_records")
}

model Production {
  id          String         @id @default(cuid())
  animalId    String
  animal      Animal         @relation(fields: [animalId], references: [id], onDelete: Cascade)
  type        ProductionType
  quantity    Decimal        @db.Decimal(10, 2)
  unit        String         // liters, eggs, kg
  recordedAt  DateTime       @default(now())
  notes       String?

  @@index([animalId, type, recordedAt])
  @@map("productions")
}

enum ProductionType {
  MILK
  EGGS
  WOOL
  OTHER
}

model BreedingRecord {
  id            String   @id @default(cuid())
  animalId      String   // Female animal
  animal        Animal   @relation(fields: [animalId], references: [id], onDelete: Cascade)
  maleId        String?  // Male animal ID (reference only)
  breedingDate  DateTime
  expectedDue   DateTime?
  actualBirthDate DateTime?
  offspring     Int?     @default(0)
  notes         String?
  status        BreedingStatus @default(BRED)
  createdAt     DateTime @default(now())

  @@index([animalId, breedingDate])
  @@map("breeding_records")
}

enum BreedingStatus {
  BRED
  PREGNANT
  BIRTHED
  FAILED
}

// ==========================================
// CROP MANAGEMENT
// ==========================================

model CropType {
  id            String   @id @default(cuid())
  name          String   @unique
  localName     String?  // Local Zambian name
  category      CropCategory
  growingDays   Int?     // Average days to harvest
  description   String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())

  plantings     Planting[]

  @@map("crop_types")
}

enum CropCategory {
  VEGETABLE
  GRAIN
  FRUIT
  LEGUME
  TUBER
  OTHER
}

model Field {
  id          String   @id @default(cuid())
  name        String
  size        Decimal  @db.Decimal(10, 4) // in hectares
  location    String?  // GPS or description
  soilType    String?
  irrigation  IrrigationType @default(RAINFED)
  notes       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  plantings   Planting[]

  @@map("fields")
}

enum IrrigationType {
  RAINFED
  DRIP
  SPRINKLER
  FLOOD
  MANUAL
}

model Planting {
  id              String        @id @default(cuid())
  cropTypeId      String
  cropType        CropType      @relation(fields: [cropTypeId], references: [id])
  fieldId         String
  field           Field         @relation(fields: [fieldId], references: [id])
  
  plantingDate    DateTime
  expectedHarvest DateTime?
  areaPlanted     Decimal       @db.Decimal(10, 4) // hectares
  seedQuantity    Decimal?      @db.Decimal(10, 2)
  seedUnit        String?       // kg, packets, etc.
  seedCost        Decimal?      @db.Decimal(10, 2)
  
  status          PlantingStatus @default(PLANNED)
  notes           String?
  season          String?       // e.g., "2024/2025 Rainy"
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  activities      CropActivity[]
  harvests        Harvest[]
  inputs          CropInput[]
  sprayPlans      SprayPlan[]

  @@index([cropTypeId, status])
  @@index([fieldId, plantingDate])
  @@map("plantings")
}

enum PlantingStatus {
  PLANNED
  PLANTED
  GROWING
  HARVESTING
  COMPLETED
  FAILED
}

model CropActivity {
  id          String       @id @default(cuid())
  plantingId  String
  planting    Planting     @relation(fields: [plantingId], references: [id], onDelete: Cascade)
  type        ActivityType
  description String?
  activityDate DateTime    @default(now())
  cost        Decimal?     @db.Decimal(10, 2)
  notes       String?
  createdAt   DateTime     @default(now())

  @@index([plantingId, activityDate])
  @@map("crop_activities")
}

enum ActivityType {
  LAND_PREP
  PLANTING
  WEEDING
  FERTILIZING
  SPRAYING
  IRRIGATION
  INSPECTION
  OTHER
}

model CropInput {
  id          String   @id @default(cuid())
  plantingId  String
  planting    Planting @relation(fields: [plantingId], references: [id], onDelete: Cascade)
  name        String   // Fertilizer name, pesticide, etc.
  type        InputType
  quantity    Decimal  @db.Decimal(10, 2)
  unit        String
  cost        Decimal? @db.Decimal(10, 2)
  appliedDate DateTime @default(now())
  notes       String?

  @@index([plantingId, appliedDate])
  @@map("crop_inputs")
}

enum InputType {
  FERTILIZER
  PESTICIDE
  HERBICIDE
  FUNGICIDE
  SEED
  OTHER
}

model Harvest {
  id          String   @id @default(cuid())
  plantingId  String
  planting    Planting @relation(fields: [plantingId], references: [id], onDelete: Cascade)
  harvestDate DateTime @default(now())
  quantity    Decimal  @db.Decimal(12, 2)
  unit        String   // kg, bags, crates
  quality     HarvestQuality @default(GOOD)
  soldQuantity Decimal? @db.Decimal(12, 2)
  soldPrice   Decimal? @db.Decimal(12, 2)
  buyer       String?
  
  harvestedById String?
  harvestedBy   User?   @relation(fields: [harvestedById], references: [id])
  notes       String?
  createdAt   DateTime @default(now())

  @@index([plantingId, harvestDate])
  @@map("harvests")
}

enum HarvestQuality {
  EXCELLENT
  GOOD
  FAIR
  POOR
}

// ==========================================
// SPRAY PLANS
// ==========================================

model SprayPlan {
  id              String        @id @default(cuid())
  plantingId      String
  planting        Planting      @relation(fields: [plantingId], references: [id], onDelete: Cascade)
  
  name            String        // e.g., "Week 2 Pest Control"
  pesticide       String        // Name of pesticide/chemical
  targetPest      String?       // What pest/disease it targets
  dosage          String        // e.g., "50ml per 20L water"
  applicationMethod String?     // e.g., "Foliar spray", "Soil drench"
  
  scheduledDate   DateTime      // When it should be applied
  status          SprayPlanStatus @default(PENDING)
  completedDate   DateTime?     // When it was actually done
  completedById   String?       // Worker who completed it
  completedBy     User?         @relation(fields: [completedById], references: [id])
  
  weatherConditions String?     // Recommended weather for application
  safetyPrecautions String?     // Safety notes for workers
  notes           String?       // Additional instructions
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([plantingId, scheduledDate])
  @@index([status])
  @@map("spray_plans")
}

enum SprayPlanStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
  OVERDUE
}

// ==========================================
// WORKER MANAGEMENT
// ==========================================

model Worker {
  id            String   @id @default(cuid())
  employeeId    String   @unique // Internal ID
  firstName     String
  lastName      String
  phone         String?
  address       String?
  nrc           String?  // National Registration Card (Zambian ID)
  dateOfBirth   DateTime?
  hireDate      DateTime @default(now())
  position      String
  workerType    WorkerType @default(PERMANENT)
  dailyRate     Decimal? @db.Decimal(10, 2)
  monthlyRate   Decimal? @db.Decimal(10, 2)
  status        WorkerStatus @default(ACTIVE)
  emergencyContact String?
  emergencyPhone   String?
  photo         String?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  attendances   Attendance[]
  payments      Payment[]
  taskAssignments TaskWorker[]

  @@map("workers")
}

enum WorkerType {
  PERMANENT
  CASUAL
  SEASONAL
  CONTRACT
}

enum WorkerStatus {
  ACTIVE
  INACTIVE
  TERMINATED
  ON_LEAVE
}

model Attendance {
  id          String         @id @default(cuid())
  workerId    String
  worker      Worker         @relation(fields: [workerId], references: [id], onDelete: Cascade)
  date        DateTime       @db.Date
  checkIn     DateTime?
  checkOut    DateTime?
  status      AttendanceStatus @default(PRESENT)
  hoursWorked Decimal?       @db.Decimal(4, 2)
  overtime    Decimal?       @db.Decimal(4, 2)
  notes       String?
  
  recordedById String?
  recordedBy   User?         @relation(fields: [recordedById], references: [id])
  createdAt   DateTime       @default(now())

  @@unique([workerId, date])
  @@index([workerId, date])
  @@map("attendances")
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  HALF_DAY
  LEAVE
  SICK
  HOLIDAY
}

model Payment {
  id          String      @id @default(cuid())
  workerId    String
  worker      Worker      @relation(fields: [workerId], references: [id], onDelete: Cascade)
  amount      Decimal     @db.Decimal(12, 2)
  paymentType PaymentType
  paymentDate DateTime    @default(now())
  periodStart DateTime?
  periodEnd   DateTime?
  daysWorked  Int?
  deductions  Decimal?    @db.Decimal(10, 2)
  bonus       Decimal?    @db.Decimal(10, 2)
  paymentMethod String?   // Cash, Mobile Money, Bank
  reference   String?     // Transaction reference
  notes       String?
  createdAt   DateTime    @default(now())

  @@index([workerId, paymentDate])
  @@map("payments")
}

enum PaymentType {
  SALARY
  WAGE
  BONUS
  ADVANCE
  OVERTIME
  OTHER
}

// ==========================================
// TASK MANAGEMENT
// ==========================================

model Task {
  id          String       @id @default(cuid())
  title       String
  description String?
  category    TaskCategory
  priority    TaskPriority @default(MEDIUM)
  status      TaskStatus   @default(PENDING)
  
  dueDate     DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  
  estimatedHours Decimal?  @db.Decimal(5, 2)
  actualHours    Decimal?  @db.Decimal(5, 2)
  
  // Relations
  createdById String
  createdBy   User         @relation("CreatedTasks", fields: [createdById], references: [id])
  assignedToId String?
  assignedTo   User?       @relation("AssignedTasks", fields: [assignedToId], references: [id])
  
  notes       String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  workers     TaskWorker[]

  @@index([status, dueDate])
  @@index([category, status])
  @@map("tasks")
}

model TaskWorker {
  id        String   @id @default(cuid())
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  workerId  String
  worker    Worker   @relation(fields: [workerId], references: [id], onDelete: Cascade)
  assignedAt DateTime @default(now())

  @@unique([taskId, workerId])
  @@map("task_workers")
}

enum TaskCategory {
  LIVESTOCK
  CROPS
  EQUIPMENT
  MAINTENANCE
  GENERAL
  ADMINISTRATIVE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ==========================================
// EQUIPMENT & TOOLS
// ==========================================

model Equipment {
  id              String           @id @default(cuid())
  name            String
  code            String           @unique // Asset code
  category        EquipmentCategory
  brand           String?
  model           String?
  serialNumber    String?
  purchaseDate    DateTime?
  purchasePrice   Decimal?         @db.Decimal(12, 2)
  currentValue    Decimal?         @db.Decimal(12, 2)
  location        String?
  status          EquipmentStatus  @default(AVAILABLE)
  condition       EquipmentCondition @default(GOOD)
  lastServiceDate DateTime?
  nextServiceDate DateTime?
  notes           String?
  photo           String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  maintenances    Maintenance[]
  usageRecords    EquipmentUsage[]

  @@index([category, status])
  @@map("equipment")
}

enum EquipmentCategory {
  VEHICLE
  TRACTOR
  HAND_TOOL
  POWER_TOOL
  IRRIGATION
  STORAGE
  PROCESSING
  OTHER
}

enum EquipmentStatus {
  AVAILABLE
  IN_USE
  MAINTENANCE
  BROKEN
  RETIRED
}

enum EquipmentCondition {
  EXCELLENT
  GOOD
  FAIR
  POOR
}

model Maintenance {
  id            String          @id @default(cuid())
  equipmentId   String
  equipment     Equipment       @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  type          MaintenanceType
  description   String
  performedBy   String?         // Internal or external
  cost          Decimal?        @db.Decimal(10, 2)
  parts         String?         // Parts replaced
  maintenanceDate DateTime      @default(now())
  nextDueDate   DateTime?
  notes         String?
  createdAt     DateTime        @default(now())

  @@index([equipmentId, maintenanceDate])
  @@map("maintenances")
}

enum MaintenanceType {
  PREVENTIVE
  REPAIR
  INSPECTION
  REPLACEMENT
  CLEANING
  OTHER
}

model EquipmentUsage {
  id          String    @id @default(cuid())
  equipmentId String
  equipment   Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  usedById    String
  usedBy      User      @relation(fields: [usedById], references: [id])
  purpose     String
  checkoutTime DateTime @default(now())
  returnTime  DateTime?
  hoursUsed   Decimal?  @db.Decimal(6, 2)
  fuelUsed    Decimal?  @db.Decimal(8, 2) // For vehicles/tractors
  notes       String?
  createdAt   DateTime  @default(now())

  @@index([equipmentId, checkoutTime])
  @@map("equipment_usage")
}

// ==========================================
// INVENTORY & SUPPLIES
// ==========================================

model InventoryItem {
  id            String   @id @default(cuid())
  name          String
  sku           String?  @unique
  category      InventoryCategory
  currentStock  Decimal  @db.Decimal(12, 2)
  unit          String   // kg, liters, pieces, bags
  minStock      Decimal? @db.Decimal(12, 2) // Reorder level
  maxStock      Decimal? @db.Decimal(12, 2)
  unitCost      Decimal? @db.Decimal(10, 2)
  location      String?  // Storage location
  supplier      String?
  expiryDate    DateTime?
  notes         String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  transactions  InventoryTransaction[]

  @@index([category, currentStock])
  @@map("inventory_items")
}

enum InventoryCategory {
  FEED
  FERTILIZER
  PESTICIDE
  SEEDS
  FUEL
  MEDICINE
  SPARE_PARTS
  PACKAGING
  OTHER
}

model InventoryTransaction {
  id          String          @id @default(cuid())
  itemId      String
  item        InventoryItem   @relation(fields: [itemId], references: [id], onDelete: Cascade)
  type        TransactionType
  quantity    Decimal         @db.Decimal(12, 2)
  unitCost    Decimal?        @db.Decimal(10, 2)
  totalCost   Decimal?        @db.Decimal(12, 2)
  reference   String?         // Invoice, receipt number
  supplier    String?
  notes       String?
  transactionDate DateTime    @default(now())
  createdAt   DateTime        @default(now())

  @@index([itemId, transactionDate])
  @@map("inventory_transactions")
}

enum TransactionType {
  PURCHASE
  USAGE
  ADJUSTMENT
  TRANSFER
  WASTE
  RETURN
}

// ==========================================
// FINANCIAL TRACKING (Basic)
// ==========================================

model Expense {
  id          String         @id @default(cuid())
  category    ExpenseCategory
  description String
  amount      Decimal        @db.Decimal(12, 2)
  paymentMethod String?
  reference   String?
  vendor      String?
  expenseDate DateTime       @default(now())
  receipt     String?        // Receipt image URL
  notes       String?
  createdAt   DateTime       @default(now())

  @@index([category, expenseDate])
  @@map("expenses")
}

enum ExpenseCategory {
  LIVESTOCK
  CROPS
  LABOR
  EQUIPMENT
  FUEL
  UTILITIES
  TRANSPORT
  VETERINARY
  SEEDS_FERTILIZER
  REPAIRS
  OTHER
}

model Income {
  id          String        @id @default(cuid())
  category    IncomeCategory
  description String
  amount      Decimal       @db.Decimal(12, 2)
  paymentMethod String?
  reference   String?
  buyer       String?
  incomeDate  DateTime      @default(now())
  notes       String?
  createdAt   DateTime      @default(now())

  @@index([category, incomeDate])
  @@map("incomes")
}

enum IncomeCategory {
  LIVESTOCK_SALE
  CROP_SALE
  MILK_SALE
  EGG_SALE
  PRODUCE_SALE
  SERVICES
  OTHER
}

// ==========================================
// SYSTEM & SYNC
// ==========================================

model SyncLog {
  id          String   @id @default(cuid())
  deviceId    String
  action      String
  tableName   String
  recordId    String
  data        Json?
  syncedAt    DateTime @default(now())
  status      SyncStatus @default(PENDING)

  @@index([deviceId, status])
  @@map("sync_logs")
}

enum SyncStatus {
  PENDING
  SYNCED
  FAILED
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  type      String   @default("string") // string, number, boolean, json
  updatedAt DateTime @updatedAt

  @@map("settings")
}
